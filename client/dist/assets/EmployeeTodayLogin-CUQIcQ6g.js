import{r as s,y as u,j as e,L as B,T as l,Y as m,P as N,a5 as W,a4 as Y,B as w,D as _}from"./index-DlcvTWOH.js";import{D as P,a as O,b as R,c as z}from"./DialogTitle-DGL2koDV.js";import{D as k}from"./DialogContentText-BFDKx7jj.js";const H="https://silitzer-pharma.onrender.com",J=(n,o)=>`https://www.google.com/maps?q=${n},${o}`,I=({label:n,location:o})=>!(o!=null&&o.latitude)||!(o!=null&&o.longitude)?null:e.jsxs(l,{variant:"body2",color:"textSecondary",gutterBottom:!0,children:[e.jsxs("strong",{children:[n,":"]})," ",e.jsxs("a",{href:J(o.latitude,o.longitude),target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none",color:"inherit"},children:[e.jsx(W,{style:{color:"red",verticalAlign:"middle"}})," "+o.latitude+","+o.longitude]})]}),U=(n,o)=>{if(!n)return"—";const a=new Date(o||Date.now())-new Date(n);if(a<0)return"—";const d=Math.floor(a/1e3);return`${String(Math.floor(d/3600)).padStart(2,"0")}:${String(Math.floor(d%3600/60)).padStart(2,"0")}:${String(d%60).padStart(2,"0")}`},q=()=>{const[n,o]=s.useState([]),[a,d]=s.useState(!1),[f,y]=s.useState(!1);s.useEffect(()=>{h()},[]);const h=async()=>{try{y(!0);const c=await(await fetch(`${H}/employee/todaylogin`,{credentials:"include"})).json();d(c.isActive),o(c.allSessions||[])}catch{u.error("Failed to fetch today's login sessions.")}finally{y(!1)}};return f?e.jsx(B,{message:"Loading sessions..."}):n.length?e.jsx(m,{mt:2,children:n.map((r,c)=>{const g=a&&c===0&&!r.logoutTime;return e.jsxs(N,{variant:"outlined",sx:{p:2,mb:2,bgcolor:g?"#e0ffe0":void 0},children:[e.jsxs(l,{variant:"subtitle1",fontWeight:g?"bold":"normal",children:["Session #",n.length-c," ",g&&"(Active)"]}),e.jsxs(l,{variant:"body2",children:["Login Time: ",r.loginTime?new Date(r.loginTime).toLocaleTimeString():"—"]}),e.jsx(I,{label:"Login Location",location:r.loginLocation}),e.jsxs(l,{variant:"body2",children:["Logout Time: ",r.logoutTime?new Date(r.logoutTime).toLocaleTimeString():"—"]}),e.jsx(I,{label:"Logout Location",location:r.logoutLocation}),e.jsxs(l,{variant:"body2",children:["Duration: ",U(r.loginTime,r.logoutTime)]})]},c)})}):e.jsx(l,{variant:"body2",color:"textSecondary",children:"No login sessions for today."})},S="https://silitzer-pharma.onrender.com",X=()=>{const{isActive:n,setIsActive:o,setLocationError:a}=Y(),[d,f]=s.useState(!1),[y,h]=s.useState(!1),[r,c]=s.useState(null),[g,x]=s.useState(!1),[b,T]=s.useState(15),j=s.useRef(null),v=s.useRef(null),L=s.useRef(null);s.useEffect(()=>(C(),$),[]),s.useEffect(()=>{if(!g)return;const t=setInterval(()=>{T(i=>(i<=1&&(clearInterval(t),x(!1),u.error("Failed to get location: timeout"),a(!0)),i-1))},1e3);return()=>clearInterval(t)},[g]);const C=async()=>{try{f(!0);const i=await(await fetch(`${S}/employee/todaylogin`,{credentials:"include"})).json();o(i.isActive),i.isActive&&A()}catch{u.error("Failed to check login status.")}finally{f(!1)}},F=()=>new Promise((t,i)=>{navigator.geolocation.getCurrentPosition(({coords:p})=>{a(!1),t(p)},p=>{a(!0),i(new Error("Location error: "+p.message))},{enableHighAccuracy:!0,timeout:15e3})}),D=async(t,i)=>{try{await fetch(`${S}/employee/livelocation`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({latitude:t,longitude:i})})}catch{u.warn("Failed to send live location.")}},A=()=>{if(!navigator.geolocation)return u.error("Geolocation not supported.");j.current=navigator.geolocation.watchPosition(({coords:t})=>{L.current=t,D(t.latitude,t.longitude),a(!1)},t=>{console.error("watchPosition error:",t.message),a(!0)},{enableHighAccuracy:!0,maximumAge:1e4}),v.current=setInterval(()=>{if(L.current){const{latitude:t,longitude:i}=L.current;D(t,i)}},2*60*1e3)},$=()=>{j.current&&navigator.geolocation.clearWatch(j.current),v.current&&clearInterval(v.current)},M=async()=>{h(!1),T(15),x(!0),f(!0);try{const{latitude:t,longitude:i}=await F();x(!1);const E=await fetch(`${S}${r==="login"?"/employee/login":"/employee/logout"}`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({latitude:t,longitude:i})}),G=await E.json();if(!E.ok)throw new Error(G.message||"Server error");r==="login"?(A(),u.success("Login successful.")):($(),u.success("Logout successful.")),await C()}catch(t){x(!1),u.error(t.message||"Something went wrong.")}finally{f(!1)}};return d?e.jsx(B,{message:"Processing..."}):e.jsxs(m,{className:"employee-today-login",sx:{p:2},children:[e.jsx(l,{variant:"h6",mb:2,children:"Today’s Login Info"}),e.jsxs(m,{mb:2,children:[e.jsx(l,{variant:"body1",gutterBottom:!0,color:n?"green":"textSecondary",children:n?"You are currently logged in.":"You have not logged in yet today."}),e.jsx(w,{variant:"contained",color:n?"error":"primary",fullWidth:!0,onClick:()=>{c(n?"logout":"login"),h(!0)},children:n?"Logout for Today":"Login for Today"})]}),e.jsx(_,{sx:{my:2}}),e.jsx(q,{}),e.jsxs(P,{open:y,onClose:()=>h(!1),children:[e.jsxs(O,{children:["Confirm ",r]}),e.jsx(R,{children:e.jsxs(k,{children:["Are you sure you want to ",r,"?"]})}),e.jsxs(z,{children:[e.jsx(w,{onClick:()=>h(!1),children:"Cancel"}),e.jsx(w,{onClick:M,autoFocus:!0,children:"OK"})]})]}),e.jsxs(P,{open:g,children:[e.jsx(O,{children:"Getting Location"}),e.jsxs(R,{children:[e.jsx(k,{children:"Please wait while we access your location."}),e.jsxs(m,{mt:2,children:[e.jsxs(l,{variant:"body2",gutterBottom:!0,children:["Time remaining: ",b,"s"]}),e.jsx(m,{sx:{width:"100%",height:10,backgroundColor:"#eee",borderRadius:5},children:e.jsx(m,{sx:{width:`${(15-b)/15*100}%`,height:"100%",backgroundColor:"#1976d2",transition:"width 1s linear",borderRadius:5}})})]})]})]})]})};export{X as default};
